# IME Switcher 使用说明

> 版本 0.5.0 · 仅支持 Windows 10 / 11

---

## 目录

### 第一部分：VS Code 扩展

1. [安装](#1-安装)
2. [快速上手](#2-快速上手)
3. [状态栏指示器](#3-状态栏指示器)
4. [命令与快捷键](#4-命令与快捷键)
5. [配置项详解](#5-配置项详解)
6. [通过 settings.json 配置](#6-通过-settingsjson-配置)
7. [使用场景示例](#7-使用场景示例)
8. [常见问题](#8-常见问题)
9. [卸载](#9-卸载)

### 第二部分：IntelliJ IDEA 插件

10. [安装（IDEA）](#10-安装idea)
11. [快速上手（IDEA）](#11-快速上手idea)
12. [状态栏指示器（IDEA）](#12-状态栏指示器idea)
13. [命令与快捷键（IDEA）](#13-命令与快捷键idea)
14. [配置项详解（IDEA）](#14-配置项详解idea)
15. [IdeaVim 集成](#15-ideavim-集成)
16. [常见问题（IDEA）](#16-常见问题idea)
17. [卸载（IDEA）](#17-卸载idea)

---

## 1. 安装

### 从 VSIX 文件安装（推荐）

1. 确保已准备好 `ime-switcher-0.5.0.vsix` 文件。
2. 打开 VS Code。
3. 按 `Ctrl+Shift+X` 打开扩展面板。
4. 点击右上角 **`···`** → **从 VSIX 安装…**。
5. 选择 `ime-switcher-0.5.0.vsix`，点击安装。
6. 弹窗提示"重新加载"时点击 **重新加载窗口**。

> 安装包内已内置 `ime-switcher.exe`，无需额外配置，开箱即用。

---

## 2. 快速上手

安装并重启 VS Code 后，扩展**自动激活**，无需任何手动操作。

**验证方法：**

1. 打开任意代码文件（如 `.ts`、`.py`、`.java`）。
2. 将光标移到中文注释旁边 → 系统输入法自动切换到**微软拼音**，状态栏显示 `中文`。
3. 将光标移到英文代码旁边 → 系统输入法自动切换到**英文**，状态栏显示 `EN`。

切换延迟默认为 **300ms**（可通过配置调整）。

---

## 3. 状态栏指示器

右下角状态栏显示当前 IME 状态：

| 显示 | 含义 |
|------|------|
| `⌨ IME` | 扩展已激活，当前语言未检测 |
| `🔤 中文` | 已切换到中文输入法 |
| `🔡 EN` | 已切换到英文输入法 |
| `⊘ IME` | 自动切换已**禁用** |

点击状态栏图标可快速切换**启用/禁用**自动切换。

---

## 4. 命令与快捷键

在命令面板（`Ctrl+Shift+P`）搜索 `IME Switcher` 可看到所有命令：

| 命令 | 默认快捷键 | 说明 |
|------|------------|------|
| `IME Switcher: 启用/禁用自动切换` | 点击状态栏 | 开关自动切换功能 |
| `IME Switcher: 手动切换到中文` | `Ctrl+Alt+Z` | 立即切换到中文输入法 |
| `IME Switcher: 手动切换到英文` | `Ctrl+Alt+E` | 立即切换到英文输入法 |

### 修改快捷键

`Ctrl+Shift+P` → **打开键盘快捷方式** → 搜索 `imeSwitcher` → 双击修改。

---

## 5. 配置项详解

打开 VS Code 设置（`Ctrl+,`），搜索 `imeSwitcher` 即可看到所有配置项。

### `imeSwitcher.enabled`
- **类型**：布尔值
- **默认**：`true`
- **说明**：全局开关，设为 `false` 完全禁用自动切换。

---

### `imeSwitcher.delayMs`
- **类型**：数字（毫秒）
- **默认**：`300`，范围 `50–2000`
- **说明**：光标移动后等待多久再检测和切换。数值越小反应越快，但在快速移动光标时可能产生短暂闪切。

**推荐值：**
- 追求快速响应：`100–150`
- 默认平衡：`300`
- 降低切换频率：`500`

---

### `imeSwitcher.executable`
- **类型**：字符串（路径）
- **默认**：空（使用内置 exe）
- **说明**：若需使用自定义或独立安装的 `ime-switcher.exe`，填写完整路径（如 `C:\tools\ime-switcher.exe`）。留空时自动使用扩展内置的 exe。

---

### `imeSwitcher.toggleKey`
- **类型**：字符串枚举
- **默认**：`"auto"`
- **可选值**：`"auto"` / `"shift"` / `"ctrl"`
- **说明**：切换微软拼音中/英文模式时注入的按键。

| 值 | 行为 |
|---|---|
| `"auto"` | 先尝试 Shift；等待 100ms 后验证 IME 状态是否变化，若未生效自动改用 Ctrl |
| `"shift"` | 仅注入 Shift 键（微软拼音**默认**切换热键） |
| `"ctrl"` | 仅注入 Ctrl 键（手动将切换热键改为 Ctrl 的用户使用） |

> **如何判断自己该用哪个值？**  
> 打开微软拼音设置 → 按键 → 查看"中/英文切换"绑定的是 Shift 还是 Ctrl。  
> 若绑定的是 Ctrl，将此项设为 `"ctrl"`；其他情况保持 `"auto"` 即可。

---

### `imeSwitcher.whitelist`
- **类型**：字符串数组
- **默认**：`[]`（空，表示全部语言启用）
- **说明**：只在列出的**语言 ID** 文件中启用自动切换。

示例（仅在 TypeScript 和 Python 文件中启用）：
```json
"imeSwitcher.whitelist": ["typescript", "python"]
```

---

### `imeSwitcher.blacklist`
- **类型**：字符串数组
- **默认**：`["markdown", "plaintext"]`
- **说明**：在列出的**语言 ID** 文件中**禁用**自动切换。

示例（额外禁用 JSON 和 YAML 文件）：
```json
"imeSwitcher.blacklist": ["markdown", "plaintext", "json", "yaml"]
```

> **白名单优先级高于黑名单。** 若同时设置，白名单生效。

---

### `imeSwitcher.log`
- **类型**：布尔值
- **默认**：`false`
- **说明**：设为 `true` 后，在 **输出面板 → IME Switcher** 查看详细调试日志，包含每次检测结果和切换调用记录。

---

### `imeSwitcher.pauseAfterManualSwitchMs`
- **类型**：数字（毫秒）
- **默认**：`3000`
- **说明**：手动切换输入法（用快捷键或键盘）后，自动切换暂停的时长，避免与用户操作冲突。

---

## 6. 通过 settings.json 配置

虽然可以在 VS Code 设置界面（`Ctrl+,` 搜索 `imeSwitcher`）通过图形化界面操作，但直接编辑 `settings.json` 更精确、可复制，也便于团队共享配置。

### 打开 settings.json

**方法 A（推荐）：命令面板**

1. 按 `Ctrl+Shift+P` 打开命令面板。
2. 输入 `Open User Settings JSON`，选择 **"首选项: 打开用户设置(JSON)"**。
3. 文件在新标签页中打开，格式为 JSON 对象 `{ ... }`。

**方法 B：设置界面入口**

1. 按 `Ctrl+,` 打开设置界面。
2. 点击右上角的 **"打开设置(JSON)"** 图标（页面图标，位于设置标签页右上角）。

**方法 C：直接找到文件**

文件通常位于：
```
C:\Users\<用户名>\AppData\Roaming\Code\User\settings.json
```
也可在文件管理器地址栏输入 `%APPDATA%\Code\User` 快速进入。

---

### 添加配置项

在 `settings.json` 的最外层 `{ }` 内添加需要的配置。如果文件已有其他配置，在最后一个配置项后加逗号，再追加新配置：

```json
{
  "editor.fontSize": 14,
  "editor.tabSize": 2,

  "imeSwitcher.enabled": true,
  "imeSwitcher.toggleKey": "ctrl",
  "imeSwitcher.delayMs": 200,
  "imeSwitcher.blacklist": ["markdown", "plaintext", "json"]
}
```

> **JSON 格式注意事项：**
> - 每个配置项之间用逗号 `,` 分隔，**最后一项不加逗号**。
> - 字符串值用双引号 `"` 包裹（不能用单引号）。
> - 数组用 `[ ]`，字符串元素间用逗号分隔。
> - 若格式有误，VS Code 会在行号旁标红波浪线提示错误位置。

---

### 常用配置片段

**将切换键改为 Ctrl（适合自定义了微软拼音切换热键的用户）：**
```json
"imeSwitcher.toggleKey": "ctrl"
```

**加快切换响应速度：**
```json
"imeSwitcher.delayMs": 150
```

**仅在代码文件中启用，禁用 Markdown 和配置文件：**
```json
"imeSwitcher.blacklist": ["markdown", "plaintext", "json", "yaml", "toml"]
```

**仅在特定语言中启用（白名单模式）：**
```json
"imeSwitcher.whitelist": ["typescript", "javascript", "python", "java", "go"]
```

**开启调试日志排查问题：**
```json
"imeSwitcher.log": true
```

**完整示例配置（适合大多数用户直接复制粘贴）：**
```json
"imeSwitcher.enabled": true,
"imeSwitcher.toggleKey": "auto",
"imeSwitcher.delayMs": 300,
"imeSwitcher.blacklist": ["markdown", "plaintext"],
"imeSwitcher.pauseAfterManualSwitchMs": 3000,
"imeSwitcher.log": false
```

---

### 保存后立即生效

按 `Ctrl+S` 保存 `settings.json`，配置**无需重启 VS Code**，立即生效。

---

## 7. 使用场景示例

### 场景 1：中英文混写代码注释

```typescript
// 这里是中文注释         ← 光标在此，自动切换到中文输入法
const name = "hello";    // ← 光标移到这里，自动切换到英文
```

### 场景 2：编写 Python 文档字符串

```python
def greet(name):
    """
    向用户打招呼          ← 在中文文档中自动用中文输入法
    :param name: str     ← 移到参数说明时切回英文
    """
```

### 场景 3：仅在特定文件类型中使用

若只想在 TypeScript 和 Python 中使用，其他文件不切换：
```json
"imeSwitcher.whitelist": ["typescript", "python"]
```

### 场景 4：微软拼音切换热键改为 Ctrl

若你在微软拼音设置中将中/英文切换键从默认 Shift 改为了 Ctrl，在 `settings.json` 中添加：
```json
"imeSwitcher.toggleKey": "ctrl"
```

---

## 8. 常见问题

**Q：安装后输入法没有自动切换？**

- 确认系统已安装中文输入法（微软拼音）。
- 检查状态栏是否显示 `⊘ IME`（表示已禁用），点击启用。
- 将光标真正放置在**紧邻**中文字符的位置（前后 1 个字符范围内）。
- 打开调试日志（`imeSwitcher.log: true`），在输出面板查看检测结果。

**Q：扩展检测到了语言切换，但输入法没有反应？**

- 默认 `auto` 模式会先尝试 Shift，若无效再尝试 Ctrl。如果你明确知道微软拼音的切换热键，可在 `settings.json` 中直接指定：
  ```json
  "imeSwitcher.toggleKey": "shift"
  ```
  或
  ```json
  "imeSwitcher.toggleKey": "ctrl"
  ```
- 打开微软拼音设置 → 按键，确认"中/英文切换"热键与此设置一致。

**Q：切换时系统弹出安全提示或杀毒软件报警？**

- `ime-switcher.exe` 使用 `SendInput` API 向系统注入 Shift/Ctrl 按键事件来触发微软拼音切换，这是正常操作。
- 将扩展目录 `bin\ime-switcher.exe` 添加到杀毒软件白名单即可。
- 如需自行验证，可在 `native-helper/` 目录用 gcc 从源码重新编译。

**Q：在 Markdown 文件中没有切换？**

- 这是默认行为，Markdown 和纯文本文件在默认黑名单中。
- 若需启用，在 `settings.json` 中将 `markdown` 从黑名单移除：
  ```json
  "imeSwitcher.blacklist": ["plaintext"]
  ```

**Q：光标移动很快时输入法"闪烁"切换？**

- 在 `settings.json` 中增大 `imeSwitcher.delayMs`，例如：
  ```json
  "imeSwitcher.delayMs": 500
  ```

**Q：如何查看扩展版本？**

- 扩展面板 → 已安装 → IME Switcher → 版本号显示在扩展名称下方。

---

## 9. 卸载

1. `Ctrl+Shift+X` 打开扩展面板。
2. 找到 **IME Switcher** → 点击齿轮图标 → **卸载**。
3. 重新加载窗口。

卸载后系统输入法恢复为手动管理，不影响已有输入法安装。

---

## 第二部分：IntelliJ IDEA 插件

---

## 10. 安装（IDEA）

### 从插件压缩包安装

1. 前往项目 [Releases](https://github.com/your-username/ime-switcher/releases) 下载最新的 `ime-switcher-idea-*.zip`。
2. 打开 IntelliJ IDEA（或任意 JetBrains IDE）。
3. 进入 **File → Settings → Plugins**（macOS：**IntelliJ IDEA → Settings → Plugins**）。
4. 点击右上角齿轮图标 → **Install Plugin from Disk…**
5. 选择下载的 `.zip` 文件，点击 **OK**。
6. 提示重启时点击 **Restart IDE**。

> 插件包内已内置 `ime-switcher.exe`，无需额外配置，开箱即用。

---

## 11. 快速上手（IDEA）

安装并重启 IDE 后，插件**自动激活**，无需任何手动操作。

**验证方法：**

1. 打开任意代码文件（如 `.java`、`.kt`、`.py`）。
2. 将光标移到中文注释旁边 → 系统输入法自动切换到**中文**，状态栏显示 `中`。
3. 将光标移到英文代码旁边 → 系统输入法自动切换到**英文**，状态栏显示 `EN`。
4. 若安装了 **IdeaVim**，进入 Normal 模式时输入法自动切换为英文。

---

## 12. 状态栏指示器（IDEA）

IDE 底部状态栏右侧显示当前 IME 状态：

| 显示 | 含义 |
|------|------|
| `IME` | 插件已激活，当前语言未检测 |
| `中` | 已切换到中文输入模式 |
| `EN` | 已切换到英文输入模式 |
| `○ IME` | 自动切换已**禁用** |

将鼠标悬停在状态栏图标上，可查看当前启用/禁用状态的提示。点击图标可快速切换**启用/禁用**自动切换。

---

## 13. 命令与快捷键（IDEA）

在 **Tools** 菜单或通过 `Ctrl+Shift+A`（Find Action）搜索 `IME` 可找到所有命令：

| 命令 | 默认快捷键 | 说明 |
|------|------------|------|
| 手动切换到中文 | `Ctrl+Alt+Z` | 立即切换到中文输入法 |
| 手动切换到英文 | `Ctrl+Alt+E` | 立即切换到英文输入法 |
| 启用/禁用 IME 自动切换 | `Ctrl+Alt+I` | 菜单文字随状态动态变化 |

### 修改快捷键

**File → Settings → Keymap** → 搜索 `IME` → 右键对应命令 → **Add Keyboard Shortcut**。

---

## 14. 配置项详解（IDEA）

进入 **File → Settings → Tools → IME Switcher** 打开插件配置面板。

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| 启用自动切换 | 复选框 | ✓（启用） | 全局开关，取消勾选即完全禁用 |
| 防抖延迟 (ms) | 数字 | `300` | 光标移动后等待多久再检测和切换，范围建议 50–2000 |
| 手动暂停时间 (ms) | 数字 | `3000` | 手动切换后自动切换暂停的时长 |
| 切换键 | 字符串 | `auto` | `shift` / `ctrl` / `auto`（含义与 VS Code 版相同） |
| 可执行文件路径 | 字符串 | 空 | 留空使用插件内置的 `ime-switcher.exe`；可指定自定义路径 |
| 黑名单语言 ID | 字符串 | `TEXT,Markdown` | 逗号分隔的语言 ID，在这些语言中**禁用**自动切换 |
| 白名单语言 ID | 字符串 | 空 | 逗号分隔的语言 ID，**只在**这些语言中启用（空=不限制） |
| 启用详细日志 | 复选框 | ☐（禁用） | 勾选后在 **Help → Show Log in Explorer** 的日志文件中输出调试信息 |

> **语言 ID 说明**：IDEA 中语言 ID 与 VS Code 不同，常见值为 `JAVA`、`kotlin`、`Python`、`TEXT`、`Markdown`、`JSON`、`XML` 等。可通过 Help → Diagnostic Tools → Language ID 查看当前文件的语言 ID。

> **白名单优先级高于黑名单**，二者仅取其一生效。

### 配置示例

**仅在 Java 和 Kotlin 文件中启用：**
```
白名单：JAVA,kotlin
```

**排除 JSON 和 XML 文件：**
```
黑名单：TEXT,Markdown,JSON,XML
```

**加快响应、缩短手动暂停：**
```
防抖延迟：150
手动暂停时间：1000
```

修改后点击 **OK** 或 **Apply**，配置**立即生效**，无需重启 IDE。

---

## 15. IdeaVim 集成

若已安装 **IdeaVim** 插件，IME Switcher 会自动启用 Vim 模式感知：

| Vim 模式 | IME Switcher 行为 |
|----------|-------------------|
| Normal / Visual / Command | 强制切换到**英文**输入法 |
| Insert / Replace | 恢复正常的上下文检测，根据光标邻近字符自动切换 |

> 集成通过反射调用 IdeaVim 内部 API 实现，对 IdeaVim 版本更宽容，不存在硬依赖。若 IdeaVim 未安装，此功能静默降级，插件其他功能不受影响。

---

## 16. 常见问题（IDEA）

**Q：安装后状态栏没有显示 IME 指示器？**

- 右键 IDE 底部状态栏 → 检查 **IME Switcher** 是否已勾选启用。
- 若仍无显示，尝试 **File → Invalidate Caches / Restart…** 清除缓存后重启。

**Q：输入法没有自动切换？**

- 确认状态栏显示的是 `IME` / `中` / `EN`，而非 `○ IME`（若是后者，点击启用）。
- 确认系统已安装并启用了微软拼音输入法。
- 勾选"启用详细日志"后重现问题，再通过 **Help → Show Log in Explorer** 查看日志文件。

**Q：IdeaVim 模式下切换不工作？**

- 确认 IdeaVim 已安装且版本较新（建议 2.x+）。
- 查看日志，确认是否有 `IdeaVim CommandState 类未找到` 的警告。如有，说明 IdeaVim API 有变化，请提交 Issue 反馈版本信息。

**Q：切换键设置为 auto 但仍然无法切换语言模式？**

- 打开微软拼音设置 → 按键，确认"中/英文切换"绑定的是 Shift 还是 Ctrl，然后在配置中明确指定对应值（`shift` 或 `ctrl`）。

**Q：与 VS Code 扩展版配置项有何区别？**

- 核心行为完全一致；主要区别是：IDEA 版黑/白名单使用逗号分隔字符串（如 `TEXT,Markdown`），而 VS Code 版使用 JSON 数组（如 `["markdown","plaintext"]`）。IDEA 版无 `hklZh` / `hklEn` 配置项（自动枚举系统已安装的键盘布局）。

---

## 17. 卸载（IDEA）

1. **File → Settings → Plugins → Installed**。
2. 找到 **IME Switcher** → 右键 → **Uninstall**。
3. 重启 IDE。

卸载后系统输入法恢复为手动管理，不影响已有输入法的安装与设置。
